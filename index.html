<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="description" content="bvrvl blog" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Source+Serif+Pro:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">

  <title>bvrvl</title>
</head>
<body>
  <div class="theme-switcher">
      <button id="theme-toggle-button">Dark/Light Theme</button>
  </div>
  
  <aside class="sidebar">
    <ul id="sidebar-page-list" style="list-style: none; padding-left: 0; margin-bottom: 2em;">
        <li><a href="#" data-post-url="posts/home.html" aria-current="page">Hello</a></li>
        <li><a href="#" data-post-url="posts/about.html">About</a></li>
        <li><a href="#" data-post-url="posts/log.html">Log</a></li>
    </ul>

    <!-- Section for General Writing -->
    <h2>Blog</h2>
    <ul id="sidebar-writing-list" style="list-style: none; padding-left: 0;">
    </ul>

    <!-- Section for Poetry -->
    <h2 style="margin-top: 2em;">Poetry</h2>
    <ul id="sidebar-poetry-list" style="list-style: none; padding-left: 0;">
    </ul>
  </aside>

  <main class="main-content" id="main-content-area">
      <header class="site-header">
        <div class="site-branding">
          <h1>bvrvl</h1>
          <p class="site-tagline">blog</p>
        </div>
        <div class="site-author">
          <p class="author-name">Saurabh Baral</p>
          <a href="mailto:saurabh@bvrvl.com" class="author-email">saurabh@bvrvl.com</a>
        </div>
      </header>
      
      <div id="post-display-area">
          <p>Loading...</p>
      </div>
      
      <div id="buttondown-embed-wrapper">
        <form action="https://buttondown.email/api/emails/embed-subscribe/bvrvl" method="post" target="popupwindow" onsubmit="window.open('https://buttondown.email/bvrvl', 'popupwindow')" class="embeddable-buttondown-form">
           <label for="bd-email">Subscribe to be pinged when I make a post:</label>
           <input type="email" name="email" id="bd-email" placeholder="you@example.com" required>
           <input type="hidden" value="1" name="embed">
           <input type="submit" value="Subscribe" />
        </form>
      </div>
      
      <footer class="site-footer-main">
        Â© <span id="current-year"></span> Saurabh Baral (bvrvl). All content licensed under <a href="http://creativecommons.org/licenses/by-sa/4.0/" rel="license" target="_blank">CC BY-SA 4.0</a>.
      </footer>
  </main>

  <script>

    // Essays and general blog posts
    const writingPosts = [
        {
            title: "Coming Soon",
            url: "posts/post-1.html"
        }
    ];

    // Poems
    const poetryPosts = [
        {
            title: "Pink Blanket of White Hearts",
            url: "posts/pink-blanket-of-white-hearts.html"
        },
        {
            title: "so in mania C",
            url: "posts/so-in-mania-c.html"
        },
        {
            title: "poorly knit sweater",
            url: "posts/poorly-knit-sweater.html"
        },
        {
            title: "Your grace is all I know",
            url: "posts/your-grace-is-all-i-know.html"
        },
        {
            title: "Angst",
            url: "posts/angst.html"
        }
    ];

    // --- References to HTML Elements ---
    const body = document.body;
    const themeToggleButton = document.getElementById("theme-toggle-button");
    const postDisplayArea = document.getElementById("post-display-area");
    const sidebar = document.querySelector(".sidebar");
    const mainContent = document.getElementById("main-content-area");

    // --- Core Functions ---

    const applyTheme = (theme) => {
      body.classList.toggle("dark-mode", theme === "dark");
      if (themeToggleButton) { themeToggleButton.textContent = theme === 'dark' ? 'Light Theme' : 'Dark Theme'; }
    };

    const loadPost = async (url, linkElement) => {
      if (!postDisplayArea || !url) return;
      if (mainContent) { mainContent.scrollTop = 0; }

      postDisplayArea.innerHTML = '<p>Loading...</p>';
      
      const allLinks = document.querySelectorAll('.sidebar a[data-post-url]');
      allLinks.forEach(link => { link.removeAttribute('aria-current'); });
      if (linkElement) { linkElement.setAttribute('aria-current', 'page'); }

      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const htmlContent = await response.text();
        const sanitizedHtml = htmlContent.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
        postDisplayArea.innerHTML = sanitizedHtml;

        const backToTop = document.createElement('a');
        backToTop.href = "#";
        backToTop.className = 'back-to-top-link';
        backToTop.textContent = 'Back to Top';
        backToTop.addEventListener('click', (e) => {
            e.preventDefault();
            if (mainContent) { mainContent.scrollTo({ top: 0, behavior: 'smooth' }); }
        });
        postDisplayArea.appendChild(backToTop);
      } catch (error) {
        console.error("Error loading post:", error);
        postDisplayArea.innerHTML = `<p>Error loading content from <code>${url}</code>. Check path and filename.</p>`;
      }
    };

    function populateList(posts, listElementId) {
        const listElement = document.getElementById(listElementId);
        if (!listElement) return;

        listElement.innerHTML = '';
        posts.forEach(post => {
            const listItem = document.createElement('li');
            const link = document.createElement('a');
            link.href = '#';
            link.setAttribute('data-post-url', post.url);
            link.textContent = post.title;
            listItem.appendChild(link);
            listElement.appendChild(listItem);
        });
    }


    // --- Event Listeners and Initialization ---

    // Single event listener for the whole sidebar
    sidebar.addEventListener('click', function(event) {
        const targetLink = event.target.closest('a[data-post-url]');
        if (targetLink) {
            event.preventDefault();
            const postUrl = targetLink.getAttribute('data-post-url');
            loadPost(postUrl, targetLink);
        }
    });

    if (themeToggleButton) {
      themeToggleButton.addEventListener("click", () => {
        let currentTheme = body.classList.contains("dark-mode") ? "light" : "dark";
        applyTheme(currentTheme);
        localStorage.setItem("theme", currentTheme);
      });
    }

    function initialize() {
        // Set the theme
        const storedTheme = localStorage.getItem("theme");
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        applyTheme(storedTheme || (prefersDark ? "dark" : "light"));
        
        // For the copyright footer
        document.getElementById("current-year").textContent = new Date().getFullYear();

        // Dynamic post lists
        populateList(writingPosts, 'sidebar-writing-list');
        populateList(poetryPosts, 'sidebar-poetry-list');

        // Load the new home page by default
        const homeUrl = "posts/home.html";
        const homeLink = sidebar.querySelector(`a[data-post-url="${homeUrl}"]`);
        loadPost(homeUrl, homeLink);
    }

    initialize();
  </script>
</body>
</html>